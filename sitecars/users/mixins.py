from PIL import Image
from django.forms import forms

from users.services.services_images import load_default_image, resize_image, convert_to_jpeg_if_needed


class PhotoProcessingMixin:
    """
       Миксин для обработки загруженных изображений. Этот миксин можно использовать в формах для
       автоматической обработки изображений перед их сохранением. Он выполняет следующие действия:
       - Проверяет, загружено ли изображение.
       - Если изображение не загружено, используется изображение по умолчанию.
       - Изменяет размер изображения до заданных параметров.
       - Преобразует изображение в формат JPEG, если оно не в этом формате.

       Используется вместе с формами, которые содержат поле `photo`.
    """
    def clean_photo(self):
        """
        проверяет и обрабатывает загруженное изображение.
        ѕреобразует его в формат JPEG, приводит к заданному размеру и обрабатывает ошибку при загрузке.
        если изображение не загружено, используетс¤ изображение по умолчанию.

        :return: кбработанное изображение в формате JPEG и нужного размера.
        :raises ValidationError: если не удается обработать изображение.
        """
        image = self.cleaned_data.get('photo')

        # если изображение не загружено, используем изображение по умолчанию
        if not image:
            image = load_default_image()
        try:
            # открываем изображение через Pillow
            img = Image.open(image)

            # приводим изображение к одному размеру
            img = resize_image(img, size=(200, 300))

            # провер¤ем формат изображени¤ и преобразуем его в JPEG, если нужно
            if img.format != 'JPEG':
                image = convert_to_jpeg_if_needed(img)

        except Exception as e:
            raise forms.ValidationError(f"Не удалось обработать изображение: {e}")

        # возвращаем обработанное изображение
        return image